name: Build Common

on:
  workflow_call:
    inputs:
      sign:
        description: 'Whether to sign the application'
        required: false
        type: boolean
        default: false
      publish:
        description: 'Whether to publish artifacts (electron-builder will publish to GitHub releases)'
        required: false
        type: boolean
        default: false
      checkout_tag:
        description: 'Tag to checkout (if any)'
        required: false
        type: string

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        include:
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout tag (if provided)
        if: inputs.checkout_tag != ''
        shell: bash
        run: |
          git checkout ${{ inputs.checkout_tag }}
          echo "Building for tag: ${{ inputs.checkout_tag }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libxkbcommon-dev libxcomposite-dev libxdamage-dev libxrandr-dev libgbm-dev libxss1 libasound2-dev

      - name: Setup macOS certificates (macOS only)
        if: matrix.os == 'macos-latest' && inputs.sign == true
        shell: bash
        env:
          MACOS_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERTIFICATE_BASE64" ] && [ "$MACOS_CERTIFICATE_BASE64" != "undefined" ]; then
            echo "Setting up macOS certificates..."
            KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
            KEYCHAIN_PASSWORD="${MACOS_KEYCHAIN_PASSWORD:-$RUNNER_TEMP}"
            
            security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            
            echo "$MACOS_CERTIFICATE_BASE64" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
            security import "$RUNNER_TEMP/certificate.p12" -k "$KEYCHAIN_PATH" -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            
            echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
            echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          else
            echo "No macOS certificate provided - will use ad-hoc signing"
          fi

      - name: Build application
        shell: bash
        env:
          CSC_IDENTITY: ${{ inputs.sign && secrets.CSC_IDENTITY || '' }}
          APPLE_TEAM_ID: ${{ inputs.sign && secrets.APPLE_TEAM_ID || '' }}
          APPLE_ID: ${{ inputs.sign && secrets.APPLE_ID || '' }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ inputs.sign && secrets.APPLE_APP_SPECIFIC_PASSWORD || '' }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true
        run: |
          if [ "${{ matrix.os }}" == "macos-latest" ] && [ -n "$KEYCHAIN_PATH" ]; then
            security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          fi
          if [ "${{ inputs.publish }}" == "true" ]; then
            yarn build -- --publish always
          else
            yarn build -- --publish never
          fi

      - name: Upload artifacts
        if: inputs.publish == false
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            release/**/*
          retention-days: 30

      - name: Cleanup macOS keychain
        if: matrix.os == 'macos-latest' && env.KEYCHAIN_PATH != ''
        shell: bash
        run: |
          if [ -n "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

